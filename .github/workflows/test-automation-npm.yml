name: Schengen Calculator Test Automation (npm)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test-accuracy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run accuracy tests
      run: npm run test
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-accuracy-results-node-${{ matrix.node-version }}
        path: |
          test/
          *.log

  eu-compliance-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run EU compliance validation
      run: |
        npm run test:eu > eu-compliance-report.txt 2>&1
        cat eu-compliance-report.txt
        
    - name: Check EU compliance status
      run: |
        if grep -q "❌" eu-compliance-report.txt; then
          echo "EU compliance tests failed"
          exit 1
        else
          echo "EU compliance tests passed"
        fi
        
    - name: Upload EU compliance report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: eu-compliance-report
        path: eu-compliance-report.txt

  edge-case-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run edge case tests
      run: |
        npm run test:edge > edge-case-report.txt 2>&1
        cat edge-case-report.txt
        
    - name: Check edge case status
      run: |
        if grep -q "❌" edge-case-report.txt; then
          echo "Edge case tests failed"
          exit 1
        else
          echo "Edge case tests passed"
        fi
        
    - name: Upload edge case report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: edge-case-report
        path: edge-case-report.txt

  performance-benchmark:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run performance benchmarks
      run: |
        npm run benchmark > performance-log.txt 2>&1
        cat performance-log.txt
        
    - name: Analyze performance results
      run: |
        echo "Performance Analysis:"
        grep -E "(Performance:|ms|PASS|FAIL)" performance-log.txt || echo "No performance data found"
        
    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: performance-log.txt

  test-summary:
    runs-on: ubuntu-latest
    needs: [test-accuracy, eu-compliance-check, edge-case-validation, performance-benchmark]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Generate test summary
      run: |
        echo "# 🧪 Schengen Calculator Test Summary" > test-summary.md
        echo "" >> test-summary.md
        echo "## Test Results" >> test-summary.md
        echo "" >> test-summary.md
        
        # Check EU compliance
        if [ -f eu-compliance-report/eu-compliance-report.txt ]; then
          if grep -q "ALL EU OFFICIAL TEST CASES PASSED" eu-compliance-report/eu-compliance-report.txt; then
            echo "- ✅ EU Compliance: PASSED" >> test-summary.md
          else
            echo "- ❌ EU Compliance: FAILED" >> test-summary.md
          fi
        fi
        
        # Check edge cases
        if [ -f edge-case-report/edge-case-report.txt ]; then
          if grep -q "ALL EDGE CASES HANDLED CORRECTLY" edge-case-report/edge-case-report.txt; then
            echo "- ✅ Edge Cases: PASSED" >> test-summary.md
          else
            echo "- ❌ Edge Cases: FAILED" >> test-summary.md
          fi
        fi
        
        # Check performance
        if [ -f performance-results/performance-log.txt ]; then
          if grep -q "ALL PERFORMANCE BENCHMARKS PASSED" performance-results/performance-log.txt; then
            echo "- ✅ Performance: PASSED" >> test-summary.md
          else
            echo "- ⚠️ Performance: CHECK REQUIRED" >> test-summary.md
          fi
        fi
        
        echo "" >> test-summary.md
        echo "Generated on: $(date -u)" >> test-summary.md
        
        cat test-summary.md
        
    - name: Upload test summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: test-summary.md